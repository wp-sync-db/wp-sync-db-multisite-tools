var wpmdb=wpmdb||{};wpmdb.mst={remote_mst_unavailable:!1},function(a,b){function c(){return"1"===w.attr("data-available")&&w.is(":checked")?!0:!1}function d(){a.wpmdb.do_action("wpmdb_lock_replace_url",!1),a.wpmdb.do_action("wpmdb_enable_table_migration_options"),w.attr("data-available","0"),w.prop("checked",!1),w.attr("disabled","disabled"),a(".mst").addClass("disabled"),x.hide()}function e(){w.attr("data-available","1"),w.removeAttr("disabled"),a(".mst").removeClass("disabled")}function f(f){return"false"===wpmdb_data.site_details.is_multisite?(d(),void v.hide()):"savefile"!==wpmdb_migration_type()&&"undefined"!=typeof b.mst.remote_connection_data&&"true"===b.mst.remote_connection_data.site_details.is_multisite?(d(),void v.hide()):"savefile"!==wpmdb_migration_type()&&!1===f&&"undefined"!=typeof b.mst.remote_connection_data&&"undefined"!=typeof b.mst.remote_connection_data.site_details&&wpmdb_data.site_details.prefix!==b.mst.remote_connection_data.site_details.prefix?(d(),n(!1),a(".mst-remote-location").html(b.mst.remote_connection_data.url),a(".mst-remote-prefix").html(b.mst.remote_connection_data.site_details.prefix),void F.show()):(F.hide(),f&&"true"===wpmdb_data.site_details.is_multisite&&"savefile"!==wpmdb_migration_type()?(d(),n(!1),void D.show()):(D.hide(),"savefile"!==wpmdb_migration_type()&&"undefined"!=typeof b.mst.remote_connection_data&&wpmdb_data.mst_version!==b.mst.remote_connection_data.mst_version?(d(),n(!1),a(".mst-remote-location").html(b.mst.remote_connection_data.url),a(".mst-remote-version").html(b.mst.remote_connection_data.mst_version),void E.show()):(E.hide(),e(),c()?(x.show(),k()):x.hide(),g(),void v.show())))}function g(){c()&&"savefile"!==wpmdb_migration_type()?a.wpmdb.do_action("wpmdb_lock_replace_url",!0):a.wpmdb.do_action("wpmdb_lock_replace_url",!1)}function h(){if(""===y.val())return void z.hide();if("savefile"!==wpmdb_migration_type()){A.hide(),C.show(),z.children("label").addClass("disabled");var a=J,b=j();"pull"===wpmdb_migration_type()&&void 0!==b.blog_id&&1<b.blog_id&&(a=a+b.blog_id+"_"),A.val(a),B.val(a),C.text(a)}else A.show(),C.hide(),z.children("label").removeClass("disabled");z.show()}function i(){var b=c();g(),a.wpmdb.do_action("wpmdbmst_select_subsite_changed",b)}function j(){var a={};if(c()){var b=y.find("option:selected").val();""===b?a=!1:(a.blog_id=b,a.domain_and_path=y.find("option:selected").text())}return a}function k(){var b=j();a.wpmdb.do_action("wpmdbmst_selected_subsite_changed",b)}function l(b){a.wpmdb.do_action("wpmdb_refresh_table_selects"),"pull"===wpmdb_migration_type()?a.wpmdb.do_action("wpmdb_update_pull_table_select"):a.wpmdb.do_action("wpmdb_update_push_table_select"),c()?(a.wpmdb.do_action("wpmdb_disable_table_migration_options"),G&&(!1===K||void 0!==K.blog_id&&void 0!==b.blog_id&&K.blog_id!==b.blog_id)&&a.wpmdb.do_action("wpmdb_select_all_tables")):a.wpmdb.do_action("wpmdb_enable_table_migration_options"),K=b}function m(d){void 0!==b.mst.remote_connection_data&&"true"!==b.mst.remote_connection_data.site_details.is_multisite&&c()&&d.last_migration_type!==d.migration_type&&setTimeout(function(){a.wpmdb.do_action("wpmdb_select_all_tables")})}function n(b){var c=H;if(void 0!==b){void 0!==b.domain_and_path&&(c="//"+b.domain_and_path);var d=!1;"pull"===wpmdb_migration_type()&&(d=!0),I&&(d=!d),d?a('.replace-row.pin .replace-right-col input[type="text"]').val(c):a('.replace-row.pin .old-replace-col input[type="text"]').val(c)}}function o(a,c){var d=j();if(void 0!==d.blog_id){if(!(1<d.blog_id)){var e=b.preg_quote(c),f=new RegExp(a+"([0-9]+)_","i"),g=f.exec(e);return null==g}a=a+d.blog_id+"_";var h=c.toLowerCase().indexOf(a.toLowerCase());if(0===h)return!0}return!1}function p(d,e){if("false"===wpmdb_data.site_details.is_multisite)return d;if(c()){if(!1===j())return!0;if(e.substr(0,J.length)!==J)return!0;if(1===b.subsite_for_table(J,e)){if(b.table_is(J,"users",e)||b.table_is(J,"usermeta",e))return d;var f=["blog_versions","blogs","registration_log","signups","site","sitemeta"];a.each(f,function(a,c){b.table_is(J,c,e)&&(d=!0)})}if("pull"===wpmdb_migration_type()&&"undefined"!=typeof b.mst.remote_connection_data&&"true"!==b.mst.remote_connection_data.site_details.is_multisite)return d;!1===o(J,e)&&(d=!0)}return d}function q(a){var c=b.preg_quote(a),d=new RegExp("[^a-z0-9_]","i"),e=d.exec(c);return null==e}function r(a,b){if("false"===wpmdb_data.site_details.is_multisite||!1===c())return a;var d=A.val();return!1===j()?(alert(wpmdbmst_strings.please_select_a_subsite),a=!1):0===d.trim().length?(alert(wpmdbmst_strings.please_enter_a_prefix),a=!1):!1===q(d)&&(alert(wpmdbmst_strings.new_prefix_contents),a=!1),a}function s(d){if(c()){var e=j();void 0!==e.blog_id&&1<e.blog_id&&("false"===wpmdb_data.site_details.is_multisite||"true"!==b.mst.remote_connection_data.site_details.is_multisite)&&a.each(d,function(a,c){!1===b.table_is(J,"users",c)&&!1===b.table_is(J,"usermeta",c)&&(!1===o(J,c)&&("pull"===wpmdb_migration_type()&&"true"===wpmdb_data.site_details.is_multisite||"push"===wpmdb_migration_type()&&"true"===b.mst.remote_connection_data.site_details.is_multisite)&&(d[a]=A.val()+c.substr(J.length)),!0===o(J,c)&&("pull"===wpmdb_migration_type()&&"false"===wpmdb_data.site_details.is_multisite||"push"===wpmdb_migration_type()&&"true"!==b.mst.remote_connection_data.site_details.is_multisite)&&(d[a]=A.val()+c.substr((J+e.blog_id+"_").length)))})}return d}function t(a){return!1!==a&&c()&&(a=!1),a}function u(a){b.mst.remote_connection_data=a,b.mst.remote_mst_unavailable="undefined"==typeof a.mst_available}var v=a(".mst-options"),w=a("#mst-select-subsite"),x=a(".mst-options .expandable-content"),y=a("#mst-selected-subsite"),z=a(".new-prefix-field"),A=a("#new-prefix"),B=a("#new-prefix-hidden"),C=a("#new-prefix-readonly"),D=a(".mst-unavailable"),E=a(".mst-different-plugin-version-notice"),F=a(".mst-different-prefix-notice"),G=!1,H=null,I=!1,J=a(".table-select-wrap .table-prefix").text(),K=!1;a.wpmdb.add_action("move_connection_info_box",function(c){J=a(".table-select-wrap .table-prefix").text(),null===H&&(H=a.wpmdb.apply_filters("wpmdb_base_old_url")),void 0!==c.migration_type&&void 0!==c.last_migration_type&&(c.migration_type===c.last_migration_type||"pull"!==c.migration_type&&"pull"!==c.last_migration_type||(I=!0)),wpmdb_toggle_migration_action_text(),f(b.mst.remote_mst_unavailable),a.wpmdb.do_action("wpmdb_refresh_table_selects"),I&&(I=!1)}),a.wpmdb.add_action("verify_connection_to_remote_site",function(a){u(a),f(b.mst.remote_mst_unavailable)}),a.wpmdb.add_action("wpmdbmst_select_subsite_changed",k),a.wpmdb.add_action("wpmdbmst_selected_subsite_changed",l),a.wpmdb.add_action("wpmdbmst_selected_subsite_changed",n),a.wpmdb.add_action("wpmdbmst_selected_subsite_changed",h),a.wpmdb.add_action("move_connection_info_box",m),a.wpmdb.add_action("wpmdb_connection_data_updated",u),a.wpmdb.add_filter("wpmdb_exclude_table",p),a.wpmdb.add_filter("wpmdb_migration_profile_ready",r),a.wpmdb.add_filter("wpmdb_backup_selected_tables",s),a.wpmdb.add_filter("wpmdbmf_enable_select_subsites",t),a(document).ready(function(){a("body").on("change","#mst-select-subsite",function(a){i()}),a("body").on("change","#mst-selected-subsite",function(a){k()}),f(b.mst.remote_mst_unavailable),G=!0})}(jQuery,wpmdb);